import unittest, json
from etk.extractors.mailman_extractor import MailmanExtractor
from etk.etk import ETK
from etk.knowledge_graph_schema import KGSchema

class TestMailmanExtractor(unittest.TestCase):

    def test_MailmanExtractor(self) -> None:
        mailing_lists = {('seesat_new.html', 'seesat-l@satobs.org'),('seesat_old.html','seesat-l@satobs.org'), ('w3.html','html-tidy@w3.org'), ('LLVMLinux.htm','LLVMLinux@lists.linuxfoundation.org'), ('linux-arm-kernel.htm','linux-arm-kernel@lists.infradead.org')}

        extracted = []
        for m in mailing_lists:
            mailman_extractor = MailmanExtractor(
                email_url = m[0],
                mailing_list_name = m[1],
                extractor_name = m[1] + '_extractor'
            )
            with open(m[0], 'r', encoding='utf8',errors='ignore') as f:
                extraction = mailman_extractor.extract(f.read())

            extracted.append(extraction.value)

        expected = [
            {'@id': 'seesat_new.html', '@type': ['EmailMessage'], '@context': {'@vocab': 'schema.org'}, 'about': {'@id': 'Re: MUOS 4 has moved', '@type': ['Thing'], '@context': {'@vocab': 'schema.org'}}, 'recipient': {'@id': 'seesat-l@satobs.org', '@type': ['Organization'], '@context': {'@vocab': 'schema.org'}}, 'sender': {'@id': 'Greg Roberts', '@type': ['Person'], '@context': {'@vocab': 'schema.org'}}, 'dateReceived': '2016-03-02T15:14:44+02:00', 'text': 'According to the info I have MUOS 4 is currently over about 60 degrees E \nand moving westward with an\norbital period of 1448.56 minutes according to data almost 19 days old.\n\nCheers\nGreg\n_______________________________________________\nSeesat-l mailing list\nhttp://mailman.satobs.org/mailman/listinfo/seesat-l', 'nextInThread': {'@id': 'http://www.satobs.org/seesat/Mar-2016/0013.html', '@type': ['URL'], '@context': {'@vocab': 'schema.org'}}, 'replyToMessage': {'@id': 'http://www.satobs.org/seesat/Mar-2016/0008.html', '@type': ['URL'], '@context': {'@vocab': 'schema.org'}}},

            {'@id': 'LLVMLinux.htm', '@type': ['EmailMessage'], '@context': {'@vocab': 'schema.org'}, 'about': {'@id': '[llvmlinux] LLVMLinux Meeting', '@type': ['Thing'], '@context': {'@vocab': 'schema.org'}}, 'recipient': {'@id': 'LLVMLinux@lists.linuxfoundation.org', '@type': ['Organization'], '@context': {'@vocab': 'schema.org'}}, 'sender': {'@id': 'Behan Webster', '@type': ['Person'], '@context': {'@vocab': 'schema.org'}}, 'dateReceived': 'Thu May 19 17:14:49 UTC 2016', 'text': 'Yes, we generally meet on Google Hangouts.\n\nBehan\n\n--\nBehan Webster\nbehanw at converseincode.com\n\n\n> On May 19, 2016, at 8:12 AM, Alexander Potapenko <glider at google.com> wrote:\n> \n> Am I understanding right that the meeting will be carried over Hangouts?\n> \n> Thanks in advance,\n> \n> On Wed, May 18, 2016 at 10:04 PM, Behan Webster <behanw at converseincode.com <mailto:behanw at converseincode.com>> wrote:\n> Due to the low response to this doodle poll, and that a number of people cant make it this week, well push the meeting off for another 2 weeks.\n> \n> Behan\n> \n> --\n> Behan Webster\n> behanw at converseincode.com <mailto:behanw at converseincode.com>\n> \n>> On May 16, 2016, at 8:59 PM, Behan Webster (via Doodle) <mailer at doodle.com <mailto:mailer at doodle.com>> wrote:\n>> \n>>  <https://doodle.com/?tmail=poll_invitecontact_participant_invitation_with_message&tlink=logo>                 \t\t\n>> Hi there,\n>>  \n>> Behan Webster (behanw at gmail.com <mailto:behanw at gmail.com>) invites you to participate in the Doodle poll "LLVMLinux Meeting."\n>> LLVMLinux project meeting\n>> Participate\xa0now <https://doodle.com/poll/i79arxxf4ru8a45b?tmail=poll_invitecontact_participant_invitation_with_message&tlink=pollbtn> \t\t\t\t\t\t\t\n>> \t\n>> What is Doodle? Doodle is a web service that helps Behan Webster to find a suitable date for meeting with a group of people. Learn more about how Doodle works. <https://doodle.com/features?tlink=checkOutLink&tmail=poll_invitecontact_participant_invitation_with_message>\n>> You have received this e-mail because "Behan Webster" has invited you to participate in the Doodle poll "LLVMLinux Meeting."\n>> Doodle is also available for iOS and Android.\n>>  <https://app.adjust.io/9wf3k9>  <https://app.adjust.com/sxd4md>\n>> Doodle AG, Werdstrasse 21, 8021 Zrich\n>> \n>> _______________________________________________\n>> LLVMLinux mailing list\n>> LLVMLinux at lists.linuxfoundation.org <mailto:LLVMLinux at lists.linuxfoundation.org>\n>> https://lists.linuxfoundation.org/mailman/listinfo/llvmlinux <https://lists.linuxfoundation.org/mailman/listinfo/llvmlinux>\n> \n> _______________________________________________\n> LLVMLinux mailing list\n> LLVMLinux at lists.linuxfoundation.org <mailto:LLVMLinux at lists.linuxfoundation.org>\n> https://lists.linuxfoundation.org/mailman/listinfo/llvmlinux <https://lists.linuxfoundation.org/mailman/listinfo/llvmlinux>\n> \n> \n> \n> -- \n> Alexander Potapenko\n> Software Engineer\n> \n> Google Germany GmbH\n> Erika-Mann-Strae, 33\n> 80636 Mnchen\n> \n> Geschftsfhrer: Matthew Scott Sucherman, Paul Terence Manicle\n> Registergericht und -nummer: Hamburg, HRB 86891\n> Sitz der Gesellschaft: Hamburg\n\n-------------- next part --------------\nAn HTML attachment was scrubbed...\nURL: <http://lists.linuxfoundation.org/pipermail/llvmlinux/attachments/20160519/695cf3d4/attachment-0001.html>'},

            {'@id': 'seesat_old.html', '@type': ['EmailMessage'], '@context': {'@vocab': 'schema.org'}, 'about': {'@id': 'Another beginner: help please.', '@type': ['Thing'], '@context': {'@vocab': 'schema.org'}}, 'recipient': {'@id': 'seesat-l@satobs.org', '@type': ['Organization'], '@context': {'@vocab': 'schema.org'}}, 'sender': {'@id': 'Charles Eltham', '@type': ['Person'], '@context': {'@vocab': 'schema.org'}}, 'dateReceived': '2000-03-03T22:24:34-08:00', 'text': "LIke Mike Bevan, I am also new both to this list and to satellite watching,\nalthough I have been an amateur astronomer for 25+ years (usually looking at\nstuff that really doesn't move that quickly!). It's good to have my interest\nin the night sky renewed.\n\nI would appreciate some help.\n\nThis morning, I was out in my garden appreciating very clear seeing, when I\nsaw two satellites crossing paths in Leo at exactly 5.32 GMT. Both around 5\nmagnitide, one travelling almost exactly N to S, and the other almost\nexactly S to N. They appeared to pass each other to within around 1 degree.\nAlthough neither object appeared to flash, the object travelling S very\nbriefly flared.\n\nHope someome can enlighten me re. identification.\n\nThanks,\n\nCharlie.\n\n\n\n\nCharlie Eltham\n9 Princes Road\nTivoli\nCheltenham\nEngland\nGL50 2TX\n\n\n\n-----------------------------------------------------------------\nUnsubscribe from SeeSat-L by sending a message with 'unsubscribe'\nin the SUBJECT to SeeSat-L-request@lists.satellite.eu.org\nhttp://www2.satellite.eu.org/seesat/seesatindex.html", 'replyToMessage': {'@id': 'http://www.satobs.org/seesat/Mar-2000/0041.html', '@type': ['URL'], '@context': {'@vocab': 'schema.org'}}},

            {'@id': 'linux-arm-kernel.htm', '@type': ['EmailMessage'], '@context': {'@vocab': 'schema.org'}, 'about': {'@id': '[PATCH net-next 5/5] net: gemini: Indicate that we can handle jumboframes', '@type': ['Thing'], '@context': {'@vocab': 'schema.org'}}, 'recipient': {'@id': 'linux-arm-kernel@lists.infradead.org', '@type': ['Organization'], '@context': {'@vocab': 'schema.org'}}, 'sender': {'@id': 'Andrew Lunn', '@type': ['Person'], '@context': {'@vocab': 'schema.org'}}, 'dateReceived': 'Sun Jul  1 00:58:54 PDT 2018', 'text': "On Sat, Jun 30, 2018 at 06:18:06PM +0200, Linus Walleij wrote:\n> The hardware supposedly handles frames up to 10236 bytes and\n> implements .ndo_change_mtu() so accept 10236 minus the ethernet\n> header for a VLAN tagged frame on the netdevices.\n> \n> Signed-off-by: Linus Walleij <linus.walleij at linaro.org>\n> ---\n>  drivers/net/ethernet/cortina/gemini.c | 5 +++++\n>  1 file changed, 5 insertions(+)\n> \n> diff --git a/drivers/net/ethernet/cortina/gemini.c b/drivers/net/ethernet/cortina/gemini.c\n> index 79324bbfd768..ae475393e4ac 100644\n> --- a/drivers/net/ethernet/cortina/gemini.c\n> +++ b/drivers/net/ethernet/cortina/gemini.c\n> @@ -2473,6 +2473,11 @@ static int gemini_ethernet_port_probe(struct platform_device *pdev)\n>  \n>  \tnetdev->hw_features = GMAC_OFFLOAD_FEATURES;\n>  \tnetdev->features |= GMAC_OFFLOAD_FEATURES | NETIF_F_GRO;\n> +\t/* We can handle jumbo frames up to 10236 bytes so, let's accept\n> +\t * payloads of 10236 bytes minus VLAN and ethernet header\n> +\t */\n> +\tnetdev->min_mtu = 256;\n> +\tnetdev->max_mtu = 10236 - VLAN_ETH_HLEN;\n\nHi Linus\n\nThe commit message does not mention the min mtu you set here. Where\ndoes 256 come from?\n\nThanks\n     Andrew"},

            {'@id': 'w3.html', '@type': ['EmailMessage'], '@context': {'@vocab': 'schema.org'}, 'about': {'@id': 'Re: New HTML Resource', '@type': ['Thing'], '@context': {'@vocab': 'schema.org'}}, 'recipient': {'@id': 'html-tidy@w3.org', '@type': ['Organization'], '@context': {'@vocab': 'schema.org'}}, 'sender': {'@id': 'Joseph Stevenson <me@josephstevenson.com>', '@type': ['Person'], '@context': {'@vocab': 'schema.org'}}, 'dateReceived': '2017-06-13T19:19:02-07:00', 'text': 'Go to\nhttps://www.w3.org/International/questions/qa-html-language-declarations\nfor language declarations help.\n\n*Joseph Stevenson*\n\n*SEO Consultant <https://josephstevenson.com/>*\n\n*P.O. BOX 531412*\n*Henderson, NV 89053*\n\nPH: (702) 907-0095 TXT: (702) 423-2145\n\n[image: http://josephstevenson.com]', 'replyToMessage': {'@id': 'http://www.w3.org/mid/New%20HTML%20Resource', '@type': ['URL'], '@context': {'@vocab': 'schema.org'}}}
        ]

        self.assertEqual(sorted(expected, key=lambda x: x["@id"]), sorted(extracted, key=lambda x: x["@id"]))
